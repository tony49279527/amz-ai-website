<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMZ AI - å®æ—¶æ§åˆ¶å°</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .terminal {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1a1b26;
            color: #a9b1d6;
        }

        .terminal-log {
            border-left: 2px solid #7aa2f7;
            padding-left: 10px;
            margin-bottom: 5px;
        }

        .blink {
            animation: blink-animation 1s steps(2, start) infinite;
        }

        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }

        /* Custom Scrollbar for Terminal */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1b26;
        }

        ::-webkit-scrollbar-thumb {
            background: #414868;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #565f89;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">AMZ AI <span class="text-blue-600">å®æ—¶æ§åˆ¶å°</span></h1>
                <p class="text-gray-500">åƒçœ‹ç§‘å¹»ç”µå½±ä¸€æ ·çœ‹ç€ä½ çš„æŠ¥å‘Šç”Ÿæˆ</p>
            </div>
            <div class="text-sm text-gray-400">Status: <span id="server-status" class="text-green-500 font-bold">â—
                    Online</span></div>
        </header>

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 transform transition-all hover:scale-[1.01]">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ç±»ç›® (Category)</label>
                    <input type="text" id="category" value="Pet Supplies"
                        class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">å…³é”®è¯ (Keywords)</label>
                    <input type="text" id="keywords" value="Smart Pet Water Fountain"
                        class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é‚®ç®± (Email)</label>
                    <input type="email" id="email" value="user@example.com"
                        class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="flex items-end">
                    <button onclick="startAnalysis()" id="start-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-md flex justify-center items-center gap-2">
                        <span>ğŸš€ å¯åŠ¨å¼•æ“</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid (Hidden by default) -->
        <div id="dashboard-ui" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left: Terminal & Progress -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Progress Bar -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between mb-2">
                        <span id="current-step" class="font-bold text-blue-600">Ready</span>
                        <span id="progress-percent" class="font-mono text-gray-500">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Terminal Window -->
                <div
                    class="bg-[#1a1b26] rounded-xl shadow-xl overflow-hidden text-sm h-[400px] flex flex-col font-mono relative group">
                    <div
                        class="bg-[#16161e] px-4 py-2 flex items-center gap-2 text-xs text-gray-400 border-b border-gray-800">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="ml-2">Live Execution Log</span>
                    </div>
                    <div id="terminal-content" class="p-4 overflow-y-auto flex-1 text-[#a9b1d6] space-y-2">
                        <div class="text-green-400">$ System initialized. Waiting for task...</div>
                    </div>
                    <!-- Auto scroll indicator -->
                    <div
                        class="absolute bottom-4 right-4 bg-blue-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                        Auto-scrolling</div>
                </div>
            </div>

            <!-- Right: Data Inspector -->
            <div class="space-y-6">
                <!-- Stat Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
                        <div class="text-xs text-gray-400 uppercase">Web Sources</div>
                        <div id="stats-sources" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500">
                        <div class="text-xs text-gray-400 uppercase">Products Found</div>
                        <div id="stats-products" class="text-2xl font-bold">0</div>
                    </div>
                </div>

                <!-- Activity Feed -->
                <div class="bg-white p-4 rounded-xl shadow h-[400px] flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“¦ æ•°æ®æ•è· (Data Capture)</h3>
                    <div id="data-feed" class="flex-1 overflow-y-auto space-y-3 pr-2">
                        <div class="text-center text-gray-400 italic text-sm mt-10">ç­‰å¾…æ•°æ®æµå…¥...</div>
                    </div>
                </div>
            </div>

            <!-- Bottom: Report Preview -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        ğŸ“„ æŠ¥å‘Šé¢„è§ˆ
                        <span id="report-status-badge"
                            class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">æœªç”Ÿæˆ</span>
                    </h2>
                    <div id="report-content"
                        class="prose max-w-none text-gray-500 min-h-[200px] border-2 border-dashed border-gray-200 rounded-lg flex items-center justify-center bg-gray-50">
                        æŠ¥å‘Šç”Ÿæˆåå°†åœ¨æ­¤æ˜¾ç¤º...
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        let socket = null;

        async function startAnalysis() {
            // UI Reset
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerHTML = `<span class="animate-spin">ğŸŒ€</span> å¯åŠ¨ä¸­...`;
            document.getElementById('dashboard-ui').classList.remove('hidden');
            document.getElementById('terminal-content').innerHTML = '';
            log("System", "Connecting to Discovery Engine...");

            const payload = {
                category: document.getElementById('category').value,
                keywords: document.getElementById('keywords').value,
                marketplace: "US",
                user_email: document.getElementById('email').value,
                user_tier: "free" // Default to free for demo
            };

            try {
                // 1. Kick off task
                const res = await fetch(`${API_BASE}/api/discovery/start-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("API Connection Failed");
                const data = await res.json();
                const taskId = data.report_id; // Currently report_id field holds task_id

                log("System", `Task ID Assigned: ${taskId}`);

                // 2. Connect WebSocket
                connectWebSocket(taskId);

            } catch (e) {
                log("Error", e.message, "text-red-500");
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerHTML = `ğŸš€ é‡è¯•`;
            }
        }

        function connectWebSocket(taskId) {
            const wsUrl = `ws://localhost:8000/ws/progress/${taskId}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                log("Network", "Real-time Link Established (WebSocket)", "text-green-400");
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleProgressUpdate(msg);
            };

            socket.onclose = () => {
                log("Network", "Connection Closed", "text-yellow-500");
            };
        }

        function handleProgressUpdate(msg) {
            // 1. Update Progress Bar
            const percent = msg.progress;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-percent').innerText = `${percent}%`;
            document.getElementById('current-step').innerText = msg.step;

            // 2. Add Terminal Log
            if (msg.details && msg.details.log) {
                log(msg.step, msg.details.log);
            } else {
                log(msg.step, msg.status);
            }

            // 3. Handle specific data events
            if (msg.step === "Web Research" && msg.details.sources_preview) {
                document.getElementById('stats-sources').innerText = msg.details.sources_preview.length;
                document.getElementById('data-feed').innerHTML = ''; // Clear empty state
                msg.details.sources_preview.forEach(source => {
                    addCardToFeed("ğŸŒ Web Source", source, "blue");
                });
            }

            if (msg.step === "Amazon Data" && msg.details.products) {
                document.getElementById('stats-products').innerText = msg.details.products.length;
                msg.details.products.forEach(p => {
                    addCardToFeed("ğŸ›’ Amazon Product", `${p.title} (${p.rating}â˜…)`, "orange");
                });
            }

            if (msg.step === "Complete" && msg.details.report_preview) {
                document.getElementById('report-status-badge').className = "bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold";
                document.getElementById('report-status-badge').innerText = "âœ… ç”Ÿæˆå®Œæˆ";

                // Render Markdown
                const md = msg.details.report_preview + "\n\n...(Full Report Saved)...";
                // In a real app we'd fetch the full HTML, but here we render the preview or full if sent
                document.getElementById('report-content').innerHTML = marked.parse(md);
                document.getElementById('report-content').classList.remove('flex', 'items-center', 'justify-center', 'text-gray-500');

                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerHTML = `ğŸš€ å†æ¥ä¸€æ¬¡`;
            }
        }

        function log(source, message, colorClass = "text-gray-300") {
            const term = document.getElementById('terminal-content');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const line = `
                <div class="terminal-log ${colorClass} font-mono text-xs mb-1">
                    <span class="opacity-50">[${time}]</span> <span class="font-bold text-blue-400">[${source}]</span> ${message}
                </div>
            `;
            term.insertAdjacentHTML('beforeend', line);
            term.scrollTop = term.scrollHeight; // Auto-scroll
        }

        function addCardToFeed(type, content, color) {
            const feed = document.getElementById('data-feed');
            const card = `
                <div class="bg-gray-50 p-3 rounded border-l-4 border-${color}-400 text-sm animate-fade-in-up">
                    <div class="font-bold text-gray-500 text-xs uppercase">${type}</div>
                    <div class="text-gray-800 truncate">${content}</div>
                </div>
            `;
            feed.insertAdjacentHTML('afterbegin', card);
        }
    </script>
<script src='js/components.js'></script>
</body>

</html>